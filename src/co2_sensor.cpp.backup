#include <HardwareSerial.h>

String receivedMessage = "";

/**
 * sensor rx -> esp32 d17
 * sensor tx -> esp32 d16
 * sensor gnd -> esp32 gnd
 * sensor vcc -> esp32 5v
 * 
 * 
 * 
 */

void setup()
{
    Serial.begin(115200);
    Serial2.begin(9600, SERIAL_8N1, 16, 17);
    Serial.println("start");
    Serial2.println((int)0xFF);
}

void loop()
{
    uint8_t data[] = {0xFF, 0x01, 0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 0x79};
    Serial2.write(data, sizeof(data) / sizeof(data[0]));

    while (Serial2.available())
    {
        char incomingData = Serial2.read();
        receivedMessage += incomingData;
    }

    if (receivedMessage != "")
    {
        Serial.println("Received: ");
        for (int i = 0; i < receivedMessage.length(); i++)
        {
            Serial.print(receivedMessage[i], HEX);
            Serial.print(" ");
        }
        Serial.print("(");
        for (int i = 0; i < receivedMessage.length(); i++)
        {
            Serial.print(receivedMessage[i], DEC);
            Serial.print(" ");
        }
        Serial.print(")");
        Serial.println();

        if (receivedMessage.length() >= 4)
        {
            uint8_t byte3 = receivedMessage[2];
            uint8_t byte4 = receivedMessage[3];

            int distance = (byte3 * 256) + byte4;
            Serial.print("Distance: ");
            Serial.println(distance);
        }
        receivedMessage = "";
    }
    Serial.println("Take");
    delay(1000);
}